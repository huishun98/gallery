<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-white md:bg-gray-100 flex items-start md:items-center justify-center">
    <div class="bg-white me:rounded-xl md:shadow-lg p-8 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-6 md:text-center">
            Upload photo or video
        </h2>

        <!-- Progress bar -->
        <div id="progressWrapper" class="mt-6 hidden">
            <div class="text-sm font-medium text-gray-700 mb-2">Upload progress</div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gray-600 h-3 rounded-full w-0"></div>
            </div>
            <div class="flex justify-between items-center mt-2">
                <div id="progressText" class="text-xs text-gray-500">0%</div>
                <button id="cancelBtn" class="text-xs text-red-600 hover:underline">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Success state -->
        <div id="successState" class="hidden text-center">
            <p class="text-xs text-gray-500 text-center mb-4">File uploaded successfully. It will be added to the slideshow once approved.</p>
            <button id="uploadAnotherBtn" class="w-full bg-gray-900 text-white py-2.5 rounded-lg font-semibold hover:bg-black transition">
                Upload again
            </button>
        </div>

        <p id="status" class="text-xs text-gray-500 mt-6 mb-6 text-center"></p>

        <form id="uploadForm" class="space-y-6">
            <label class="block">
                <span class="text-sm font-medium text-gray-700">
                    Choose a file
                </span>
                <input id="fileInput" type="file" name="picture" accept="image/*,video/*" required class="mt-2 block w-full text-sm text-gray-600
                 file:mr-4 file:py-2 file:px-4
                 file:rounded-lg file:border-0
                 file:text-sm file:font-semibold
                 file:bg-gray-50 file:text-gray-700
                 hover:file:bg-gray-100" />
            </label>

            <button id="uploadBtn" type="submit"
                class="w-full bg-gray-900 text-white py-2.5 rounded-lg font-semibold hover:bg-black transition">
                Upload
            </button>
        </form>

        {{if .DanmuEnabled}}
        <div class="border-t border-gray-200 mt-8 pt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 md:text-center">Comment on a photo or video</h3>
            <form id="commentForm" class="space-y-4">
                <input type="hidden" id="selectedFilename" name="filename" />
                <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">Choose a photo or video</div>
                    <div id="mediaGrid" class="grid grid-cols-2 gap-3"></div>
                    <p id="mediaEmpty" class="text-xs text-gray-500 mt-2 hidden">No photos found yet.</p>
                    <div id="mediaPagination"
                        class="mt-3 flex items-center justify-between text-xs text-gray-600 hidden">
                        <button id="mediaPrev" type="button"
                            class="px-3 py-1 rounded border border-gray-200 hover:border-gray-400">Prev</button>
                        <div id="mediaPageInfo"></div>
                        <button id="mediaNext" type="button"
                            class="px-3 py-1 rounded border border-gray-200 hover:border-gray-400">Next</button>
                    </div>
                </div>
                <label class="block">
                    <span class="text-sm font-medium text-gray-700">
                        Comment
                    </span>
                    <textarea id="commentInput" name="comment" rows="3" placeholder="Write a short comment..." class="mt-2 block w-full rounded-lg border border-gray-300 p-2 text-sm text-gray-700
                        focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                </label>
                <button type="submit"
                    class="w-full bg-gray-900 text-white py-2.5 rounded-lg font-semibold hover:bg-black transition">
                    Submit Comment
                </button>
                <p id="commentStatus" class="text-xs text-gray-500 text-center"></p>
            </form>
        </div>
        {{end}}
    </div>

    <script>
        const form = document.getElementById("uploadForm");
        const progressWrapper = document.getElementById("progressWrapper");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const status = document.getElementById("status");
        const successState = document.getElementById("successState");
        const uploadBtn = document.getElementById("uploadBtn");
        const uploadAnotherBtn = document.getElementById("uploadAnotherBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const commentForm = document.getElementById("commentForm");
        let xhr;

        if (commentForm) {
            const mediaGrid = document.getElementById("mediaGrid");
            const mediaEmpty = document.getElementById("mediaEmpty");
            const mediaPagination = document.getElementById("mediaPagination");
            const mediaPrev = document.getElementById("mediaPrev");
            const mediaNext = document.getElementById("mediaNext");
            const mediaPageInfo = document.getElementById("mediaPageInfo");
            const selectedFilename = document.getElementById("selectedFilename");
            const commentInput = document.getElementById("commentInput");
            const commentStatus = document.getElementById("commentStatus");

            let currentPage = 1;
            const pageSize = 4;
            let totalPages = 1;

            const isVideoFile = (filename) => {
                return /\.(mp4|webm|mov)$/i.test(filename);
            };

            const renderMediaGrid = (files) => {
                mediaGrid.innerHTML = "";

                if (!files.length) {
                    mediaEmpty.classList.remove("hidden");
                    mediaPagination.classList.add("hidden");
                    return;
                }

                mediaEmpty.classList.add("hidden");
                mediaPagination.classList.remove("hidden");

                mediaPageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
                mediaPrev.disabled = currentPage === 1;
                mediaNext.disabled = currentPage === totalPages;
                mediaPrev.classList.toggle("opacity-50", mediaPrev.disabled);
                mediaNext.classList.toggle("opacity-50", mediaNext.disabled);

                files.forEach((file) => {
                    const button = document.createElement("button");
                    button.type = "button";
                    button.className = "group border border-gray-200 rounded-lg overflow-hidden text-left hover:border-blue-500 focus:outline-none";
                    button.dataset.filename = file;

                    const filename = file.split("/").pop();
                    const mediaMarkup = isVideoFile(filename)
                        ? `
                            <video src="${file}" class="w-full h-full object-cover" muted playsinline></video>
                          `
                        : `
                            <img src="${file}" alt="" class="w-full h-full object-cover group-hover:scale-105 transition" />
                          `;

                    button.innerHTML = `
                        <div class="aspect-square bg-gray-50 flex items-center justify-center overflow-hidden">
                            ${mediaMarkup}
                        </div>
                        <div class="p-2 text-xs text-gray-600 truncate">${filename}</div>
                    `;

                    button.addEventListener("click", () => {
                        const buttons = mediaGrid.querySelectorAll("button");
                        buttons.forEach((btn) => btn.classList.remove("ring-2", "ring-blue-500"));
                        button.classList.add("ring-2", "ring-blue-500");
                        selectedFilename.value = file.split("/").pop();
                        commentStatus.innerText = "";
                    });

                    mediaGrid.appendChild(button);
                });
            };

            const fetchMediaPage = (page) => {
                fetch(`/media?page=${page}&size=${pageSize}`)
                    .then((res) => res.json())
                    .then((data) => {
                        const items = Array.isArray(data.items) ? data.items : [];
                        currentPage = data.page || page;
                        totalPages = Math.max(1, Math.ceil((data.total || 0) / pageSize));
                        renderMediaGrid(items);
                    })
                    .catch(() => {
                        mediaEmpty.classList.remove("hidden");
                        mediaEmpty.innerText = "Unable to load media.";
                    });
            };

            fetchMediaPage(currentPage);

            mediaPrev.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    fetchMediaPage(currentPage);
                }
            });

            mediaNext.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage += 1;
                    fetchMediaPage(currentPage);
                }
            });

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("picture", file);

            xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload");

            uploadBtn.classList.add("hidden");
            cancelBtn.classList.remove("hidden"); // show cancel during upload

            xhr.upload.addEventListener("progress", (event) => {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressWrapper.classList.remove("hidden");
                    progressBar.style.width = percent + "%";
                    progressText.innerText = percent + "%";
                    status.innerText = "";
                }
            });

            xhr.onload = () => {
                progressWrapper.classList.add("hidden");
                if (xhr.status === 200) {
                    form.classList.add("hidden");
                    successState.classList.remove("hidden");
                    status.innerText = "";

                    // Hide cancel on success
                    cancelBtn.classList.add("hidden");
                } else {
                    uploadBtn.classList.remove("hidden");
                    status.innerText = "Upload failed: " + xhr.responseText;
                    status.className = "text-xs text-red-600 mt-6 text-center";
                }
            };

            xhr.onerror = () => {
                uploadBtn.classList.remove("hidden");
                status.innerText = "Upload failed: network error";
                status.className = "text-xs text-red-600 mt-6 text-center";
            };

            xhr.send(formData);
        });

        cancelBtn.addEventListener("click", () => {
            if (xhr) {
                xhr.abort();
            }

            form.reset();
            progressWrapper.classList.add("hidden");
            progressBar.style.width = "0%";
            progressText.innerText = "0%";
            status.innerText = "Upload cancelled";
            status.className = "text-xs text-gray-500 mt-6 text-center";

            uploadBtn.classList.remove("hidden");
            cancelBtn.classList.add("hidden");
        });

        uploadAnotherBtn.addEventListener("click", () => {
            form.reset();
            form.classList.remove("hidden");
            progressWrapper.classList.add("hidden");
            progressBar.style.width = "0%";
            progressText.innerText = "0%";
            successState.classList.add("hidden");
            status.innerText = "";
            status.className = "text-xs text-gray-500 mt-6 text-center";

            uploadBtn.classList.remove("hidden");
            cancelBtn.classList.add("hidden");
        });

            commentForm.addEventListener("submit", (e) => {
            e.preventDefault();
            commentStatus.className = "text-xs text-gray-500 text-center";

            if (!selectedFilename.value) {
                commentStatus.innerText = "Select a media file first.";
                return;
            }

            if (!commentInput.value.trim()) {
                commentStatus.innerText = "Add a comment before submitting.";
                return;
            }

            const formData = new FormData();
            formData.append("filename", selectedFilename.value);
            formData.append("comment", commentInput.value.trim());

            fetch("/comment", { method: "POST", body: formData })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error("Request failed");
                    }
                    commentStatus.innerText = "Comment saved.";
                    commentInput.value = "";
                })
                .catch(() => {
                    commentStatus.className = "text-xs text-red-600 text-center";
                    commentStatus.innerText = "Failed to save comment.";
                });
            });
        }
    </script>

</body>

</html>
